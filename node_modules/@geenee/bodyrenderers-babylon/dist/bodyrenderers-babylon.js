import{SceneRenderer as k,ScenePlugin as V,CanvasRenderer as s,ShaderPlugin as n,ShaderRenderer as P,ImageTexture as h}from'@geenee/armature';import*as N from'@babylonjs/core';import{meshReference as G,meshTriangles as U,meshUV as W}from'@geenee/bodytracking';import{DilationShader as e}from'@geenee/bodyrenderers-common';class x extends k{constructor(d,q,T){super({'container':d,'mode':q,'layerCount':0x2,'mirror':T}),this['cameraAngle']=0xa/0xb4*Math['PI'];const a=this['canvas']['layers'][0x1];this['renderer']=new N['Engine'](a,!0x0,{'alpha':!0x0,'preserveDrawingBuffer':!0x0},!0x0);const p=window['devicePixelRatio'];this['renderer']['setSize'](a['clientWidth']*p,a['clientHeight']*p),this['canvas']['on']('resize',()=>{this['renderer']['setSize'](a['clientWidth']*p,a['clientHeight']*p);}),this['scene']=new N['Scene'](this['renderer']),this['scene']['useRightHandedSystem']=!0x0,this['scene']['createDefaultEnvironment']({'createSkybox':!0x1,'createGround':!0x1}),this['scene']['clearColor']=new N['Color4'](0x0,0x0,0x0,0x0),this['camera']=new N['UniversalCamera']('camera',new N['Vector3'](0x0,0x0,0x0),this['scene']),this['camera']['rotationQuaternion']=new N['Quaternion'](0x1,0x0,0x0,0x0),this['camera']['fov']=this['cameraAngle'],this['camera']['minZ']=0.02,this['camera']['maxZ']=0x14;}['updateScene'](){var d;(d=this['scene'])==null||d['render']();}['dispose'](){var d;this['renderer']['dispose'](),this['camera']['dispose'](),(d=this['scene'])==null||d['dispose'](),super['dispose']();}['setupCamera'](d,q){super['setupCamera'](d,q),this['camera']['fov']=this['cameraAngle'],this['camera']['getProjectionMatrix'](!0x0);}}class B extends V{}class D extends B{}class l extends B{}class L extends k{constructor(d,q,T){super({'container':d,'mode':q,'layerCount':0x1,'mirror':T}),this['cameraAngle']=0xa/0xb4*Math['PI'];const a=this['canvas']['layers'][0x0];this['renderer']=new N['Engine'](a,!0x0,{'alpha':!0x0,'preserveDrawingBuffer':!0x0},!0x0);const p=window['devicePixelRatio'];this['renderer']['setSize'](a['clientWidth']*p,a['clientHeight']*p),this['canvas']['on']('resize',()=>{this['renderer']['setSize'](a['clientWidth']*p,a['clientHeight']*p);}),this['scene']=new N['Scene'](this['renderer']),this['scene']['useRightHandedSystem']=!0x0,this['scene']['createDefaultEnvironment']({'createSkybox':!0x1,'createGround':!0x1}),this['scene']['clearColor']=new N['Color4'](0x0,0x0,0x0,0x0),this['camera']=new N['UniversalCamera']('camera',new N['Vector3'](0x0,0x0,0x0),this['scene']),this['camera']['rotationQuaternion']=new N['Quaternion'](0x1,0x0,0x0,0x0),this['camera']['fov']=this['cameraAngle'],this['camera']['minZ']=0.02,this['camera']['maxZ']=0x14,this['layer']=new N['Layer']('video',null,this['scene'],!0x0);}['updateVideo'](d){var q;if(!this['current']||!this['shader'])return;this['shader']['process']([this['current']],{'flip':[0x1]});const T=(q=this['shader']['output'])==null?void 0x0:q['texture']();return T&&(this['layer']['texture']=new N['BaseTexture'](this['renderer'],this['renderer']['wrapWebGLTexture'](T))),s['prototype']['updateVideo']['call'](this,d);}['updateScene'](){var d;(d=this['scene'])==null||d['render']();}['dispose'](){var d;this['layer']['dispose'](),this['camera']['dispose'](),(d=this['scene'])==null||d['dispose'](),this['renderer']['dispose'](),super['dispose']();}['setupVideo'](d,q){var T,p;s['prototype']['setupVideo']['call'](this,d,q);const {width:Q,height:k0}=this['videoSize'];(T=this['input'])==null||T['resize']({'width':Q,'height':k0}),(p=this['shader'])==null||p['resize']({'width':Q,'height':k0});}['setupCamera'](d,q){super['setupCamera'](d,q),this['camera']['fov']=this['cameraAngle'],this['camera']['getProjectionMatrix'](!0x0);}}class R extends L{}class f extends L{}class v extends B{constructor(d,q=!0x1){super(),this['node']=d,this['shapeScale']=q;}async['update'](d,q){if(!this['loaded'])return;const T=d['faces']&&d['faces']['length']>0x0?d['faces'][0x0]['transform']:void 0x0;if(!T)return this['node']['setEnabled'](!0x1),super['update'](d,q);const p=N['Vector3']['FromArray'](T['translation']),Q=new N['Vector3']()['setAll'](T['scale']),k0=N['Vector3']['FromArray'](T['shapeScale'])['scale'](T['scale']),k1=N['Quaternion']['FromArray'](T['rotation']);return this['node']['setEnabled'](!0x0),this['node']['rotationQuaternion']=k1,this['node']['position']=p,this['node']['scaling']=this['shapeScale']?k0:Q,super['update'](d,q);}}class t extends B{constructor(d,q=0x0,T=!0x1){super(),this['node']=d,this['facePoint']=q,this['shapeScale']=T;}async['update'](d,q){if(!this['loaded'])return;const {transform:T=void 0x0,metric:p=void 0x0}=d['faces']&&d['faces']['length']>0x0?d['faces'][0x0]:{};if(!T||!p)return this['node']['setEnabled'](!0x1),super['update'](d,q);const Q=N['Vector3']['FromArray'](p[this['facePoint']]),k0=new N['Vector3']()['setAll'](T['scale']),k1=N['Vector3']['FromArray'](T['shapeScale'])['scale'](T['scale']),k2=N['Quaternion']['FromArray'](T['rotation']);return this['node']['setEnabled'](!0x0),this['node']['rotationQuaternion']=k2,this['node']['position']=Q,this['node']['scaling']=this['shapeScale']?k1:k0,super['update'](d,q);}}class m extends B{constructor(d){super(),this['mesh']=d,this['pointCont']=G['length'];}async['load'](d){this['loaded']||(await super['load'](d),await this['setMesh'](this['mesh']));}async['update'](d,q){var T;if(!this['loaded'])return;const a=d['faces']&&d['faces']['length']>0x0?d['faces'][0x0]['metric']:void 0x0;return!a||!this['mesh']?((T=this['mesh'])==null||T['setEnabled'](!0x1),super['update'](d,q)):(this['mesh']['setEnabled'](!0x0),this['mesh']['updateVerticesData'](N['VertexBuffer']['PositionKind'],a['slice'](0x0,this['pointCont'])['flat']()),super['update'](d,q));}async['setMesh'](d){if(delete this['mesh'],this['mesh']=d,!(!this['loaded']||!d)){var q=new N['VertexData']();q['positions']=G['flat'](),q['indices']=U['flat'](),q['uvs']=W['flat'](),q['normals']=[],N['VertexData']['ComputeNormals'](q['positions'],q['indices'],q['normals']),q['applyToMesh'](d,!0x0),d['renderingGroupId']=0x1;}}}class Y extends D{constructor(d,q={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(),this['node']=d,this['tune']=q,this['avatarLength']=0x1,this['alignScore']=0.9,this['alignVisibility']=0.9;}async['load'](d){this['loaded']||(await super['load'](d),await this['setNode'](this['node']));}['unload'](){!this['loaded']||(delete this['node'],delete this['skeletonNodes'],delete this['skeleton'],delete this['spineCurve'],super['unload']());}['setNode'](q){var p,Q;if(delete this['skeletonNodes'],delete this['skeleton'],delete this['spineCurve'],this['node']=q,!this['loaded']||!q)return;this['skeleton']=((p=q['getChildMeshes'](!0x1)['find'](kw=>kw['skeleton']))==null?void 0x0:p['skeleton'])||void 0x0;const k0=(Q=this['skeleton'])==null?void 0x0:Q['bones'];if(!k0)return;const k1=kw=>{var kE;return(kE=k0['find'](kx=>kx['name']['toLowerCase']()['endsWith'](kw)))==null?void 0x0:kE['getTransformNode']();},k2={'hips':k1('hips'),'spine':k1('spine'),'spine1':k1('spine1'),'spine2':k1('spine2'),'neck':k1('neck'),'head':k1('head'),'headEnd':k1('headtop_end'),'shoulderL':k1('leftshoulder'),'shoulderR':k1('rightshoulder'),'armL':k1('leftarm'),'armR':k1('rightarm'),'foreArmL':k1('leftforearm'),'foreArmR':k1('rightforearm'),'handL':k1('lefthand'),'handR':k1('righthand'),'upLegL':k1('leftupleg'),'upLegR':k1('rightupleg'),'legL':k1('leftleg'),'legR':k1('rightleg'),'footL':k1('leftfoot'),'footR':k1('rightfoot'),'toeL':k1('lefttoebase'),'toeR':k1('righttoebase')};this['skeletonNodes']=k2;const k3=k2['hips']['absolutePosition'],k4=k2['armL']['absolutePosition'],k5=k2['armR']['absolutePosition'],k6=N['Vector3']['Lerp'](k4,k5,0.5)['subtract'](k3)['length'](),k7=k4['subtract'](k3),k8=k5['subtract'](k3)['cross'](k7)['normalize'](),k9=k2['spine']['absolutePosition']['subtract'](k3),kk=N['Vector3']['Dot'](k9,k8),kb=k9['subtract'](k8['scale'](kk))['length'](),kV=k2['spine1']['absolutePosition']['subtract'](k3),ks=N['Vector3']['Dot'](kV,k8),kn=kV['subtract'](k8['scale'](ks))['length'](),kj=k2['spine2']['absolutePosition']['subtract'](k3),kO=N['Vector3']['Dot'](kj,k8),kP=kj['subtract'](k8['scale'](kO))['length'](),kh=k2['head']['absolutePosition'],kN=k2['headEnd']['absolutePosition']['subtract'](kh)['length']();this['avatarLength']=k6,this['spineCurve']={'hips':[k3['x'],k3['y']],'spine':[kb/k6,kk/k6],'spine1':[kn/k6,ks/k6],'spine2':[kP/k6,kO/k6],'head':[kN/k6,0x0]};let {min:kG,max:kU}=q['getHierarchyBoundingVectors']();const kW=kG['add'](kU)['scale'](0.5),ke=kU['subtract'](kG),kr=Math['max'](ke['x'],ke['y'],ke['z'])*1.1*0.5,kZ=new N['Vector3'](kr,kr,kr);kG=kW['subtract'](kZ),kU=kW['add'](kZ),q['getChildMeshes'](!0x1)['forEach'](kw=>{kw['buildBoundingInfo'](kG,kU);});}async['update'](q,T){var p,Q;if(!this['loaded'])return;const k0=q['poses']&&q['poses']['length']>0x0?q['poses'][0x0]['points']:void 0x0,{node:k1,skeletonNodes:k2,spineCurve:k3}=this;if(!k2||!k3||!k0||!k1)return k1==null||k1['setEnabled'](!0x1),super['update'](q,T);k1['setEnabled'](!0x0);const k4=this['estimateBones'](k0,k3),k5=((p=this['spineCurve'])==null?void 0x0:p['hips'])||[0x0,0x1],k6=k4['hips']['rotation'],k7=k4['hips']['position']['add'](new N['Vector3'](-k5[0x0],-k5[0x1],0x0)['applyRotationQuaternionInPlace'](k6));return this['alignBone']({'position':k7,'rotation':k6},k1),(Q=this['skeleton'])==null||Q['returnToRest'](),this['updateSpine'](k4),this['updateHandL'](k4,k0),this['updateHandR'](k4,k0),this['updateLegL'](k4,k0),this['updateLegR'](k4,k0),super['update'](q,T);}['updateSpine'](d){var q;const {skeletonNodes:T}=this;if(!T)return;this['alignBone'](d['hips'],T['hips'],!0x1),this['alignBone'](d['spine'],T['spine']),this['alignBone'](d['spine1'],T['spine1']),this['alignBone'](d['spine2'],T['spine2']),this['alignBone'](d['neck'],T['neck'],!0x1),this['alignBone'](d['head'],T['head'],!0x1);const p=(q=this['skeleton'])==null?void 0x0:q['bones']['find'](Q=>Q['name']['endsWith']('HeadEnd'));if(p){const {head:Q,headEnd:k0}=d,k1=k0['position']['subtract'](Q['position'])['length']();T['head']['scaling']['setAll'](1.05*k1/p['position']['length']());}this['alignBone'](d['shoulderL'],T['shoulderL'],!0x1),this['alignBone'](d['shoulderR'],T['shoulderR'],!0x1);}['updateHandL'](d,q){const {skeletonNodes:T}=this;if(!T)return;const {alignScore:a,alignVisibility:p}=this;this['alignBone'](d['armL'],T['armL']),!(q['elbowL']['score']<a&&q['elbowL']['visibility']<p)&&(this['alignBone'](d['foreArmL'],T['foreArmL']),this['alignBone'](d['handL'],T['handL']),T['handL']['scaling']['setAll'](0.95));}['updateHandR'](d,q){const {skeletonNodes:T}=this;if(!T)return;const {alignScore:a,alignVisibility:p}=this;this['alignBone'](d['armR'],T['armR']),!(q['elbowR']['score']<a&&q['elbowR']['visibility']<p)&&(this['alignBone'](d['foreArmR'],T['foreArmR']),this['alignBone'](d['handR'],T['handR']),T['handR']['scaling']['setAll'](0.95));}['updateLegL'](d,q){const {skeletonNodes:T}=this;if(!T)return;const {alignScore:a,alignVisibility:p}=this;q['hipL']['score']<a&&q['hipL']['visibility']<p||(this['alignBone'](d['upLegL'],T['upLegL'],!0x1),!(q['kneeL']['score']<a&&q['kneeL']['visibility']<p)&&(this['alignBone'](d['legL'],T['legL']),!(q['ankleL']['score']<a&&q['ankleL']['visibility']<p)&&(this['alignBone'](d['footL'],T['footL']),this['alignBone'](d['toeL'],T['toeL']))));}['updateLegR'](d,q){const {skeletonNodes:T}=this;if(!T)return;const {alignScore:a,alignVisibility:p}=this;q['hipR']['score']<a&&q['hipR']['visibility']<p||(this['alignBone'](d['upLegR'],T['upLegR'],!0x1),!(q['kneeR']['score']<a&&q['kneeR']['visibility']<p)&&(this['alignBone'](d['legR'],T['legR']),!(q['ankleR']['score']<a&&q['ankleR']['visibility']<p)&&(this['alignBone'](d['footR'],T['footR']),this['alignBone'](d['toeR'],T['toeR']))));}['estimateBones'](p,k0){var k1;const k2=new N['Vector3'](...p['hipL']['metric']),k3=new N['Vector3'](...p['hipR']['metric']),k4=N['Vector3']['Lerp'](k2,k3,0.5),k5=k2['subtract'](k3)['normalize'](),k6=k5['negate'](),k7=new N['Vector3'](...p['shoulderL']['metric']),k8=new N['Vector3'](...p['shoulderR']['metric']),k9=new N['Vector3'](...p['elbowL']['metric']),kk=new N['Vector3'](...p['elbowR']['metric']),kb=N['Vector3']['Lerp'](k7,k8,0.5),kV=k7['subtract'](k8)['normalize'](),ks=k7['subtract'](k4),kn=k8['subtract'](k4)['cross'](ks)['normalize']();if(this['tune']['shoulderDX']||this['tune']['shoulderDY']||this['tune']['shoulderDZ']){const bB=kV['scale'](this['tune']['shoulderDX']||0x0),bD=kb['subtract'](k4)['normalize']()['scale'](this['tune']['shoulderDY']||0x0)['add'](kn['scale'](((k1=this['tune'])==null?void 0x0:k1['shoulderDZ'])||0x0));k7['addInPlace'](bD)['addInPlace'](bB),k8['addInPlace'](bD)['addInPlace'](bB['negate']());}const kj=N['Vector3']['Lerp'](k7,k8,0.5),kO=kj['subtract'](k4)['normalize'](),kP=k9['subtract'](k7)['normalize'](),kh=kk['subtract'](k8)['normalize']();let kN;if(this['tune']['neckAdjust']){const bl=Math['abs'](kV['x']);kN=kO['scale'](bl*(N['Vector3']['Dot'](kO,kP)*-this['tune']['neckAdjust']+N['Vector3']['Dot'](kO,kh)*-this['tune']['neckAdjust'])),kj['addInPlace'](kN);}const kG=kj['subtract'](k4)['length'](),kU=this['tune']['shoulderOffset']||0.2,kW=N['Vector3']['Lerp'](kj,k7,kU),kr=N['Vector3']['Lerp'](kj,k8,kU),kZ=new N['Vector3'](...p['earL']['metric']),kw=new N['Vector3'](...p['earR']['metric']),kE=N['Vector3']['Lerp'](kZ,kw,0.5),kx=new N['Vector3'](...p['nose']['metric']),kB=kE['subtract'](kx)['normalize'](),kD=kZ['subtract'](kw)['normalize'](),kl=kD['cross'](kB)['add'](kB['scale'](0.05))['normalize'](),kL=this['tune']['headRatio']||0.32,kR=k0['head'][0x0]*kG,kf=kE['add'](kl['cross'](kD)['scale'](0.025)),kv=kf['add'](kl['scale'](-kL*kR)),km=kf['add'](kl['scale']((0x1-kL)*kR)),kY=N['Vector3']['Lerp'](kv,km,0x2),ky=N['Vector3']['Lerp'](kV,kD,0.5),kF=kN?k7['add'](kN):k7['clone'](),ko=kN?k8['add'](kN):k8['clone'](),kz=N['Vector3']['Lerp'](k2,kF,k0['spine'][0x0]),kS=N['Vector3']['Lerp'](k3,ko,k0['spine'][0x0]),ki=N['Vector3']['Lerp'](kz,kS,0.5),kC=kz['subtract'](kS),kA=N['Vector3']['Lerp'](k2,kF,k0['spine1'][0x0]),kK=N['Vector3']['Lerp'](k3,ko,k0['spine1'][0x0]),kX=N['Vector3']['Lerp'](kA,kK,0.5),kc=kA['subtract'](kK),kM=N['Vector3']['Lerp'](k2,kF,k0['spine2'][0x0]),kg=N['Vector3']['Lerp'](k3,ko,k0['spine2'][0x0]),kI=N['Vector3']['Lerp'](kM,kg,0.5),ku=kA['subtract'](kg);if(this['tune']['spineCurve']){const bL=k7['subtract'](k4),bR=k8['subtract'](k4)['cross'](bL)['normalize'](),bf=this['tune']['spineCurve']*kG;ki['addInPlace'](bR['scale'](k0['spine'][0x1]*bf)),kX['addInPlace'](bR['scale'](k0['spine1'][0x1]*bf)),kI['addInPlace'](bR['scale'](k0['spine2'][0x1]*bf));}const kJ=new N['Vector3'](...p['wristL']['metric']),kH=kJ['subtract'](k9)['normalize']()['subtract'](kP)['negate'](),kd=kn['clone'](),kq=N['Vector3']['Lerp'](kH,kd,0.5),kT=new N['Vector3'](...p['indexL']['metric']),ka=new N['Vector3'](...p['pinkyL']['metric']),kp=N['Vector3']['Lerp'](kT,ka,0.5),kQ=ka['subtract'](kT),b0=new N['Vector3'](...p['wristR']['metric']),b1=b0['subtract'](kk)['normalize']()['subtract'](kh),b2=kn['negate'](),b3=N['Vector3']['Lerp'](b1,b2,0.5),b4=new N['Vector3'](...p['indexR']['metric']),b5=new N['Vector3'](...p['pinkyR']['metric']),b6=N['Vector3']['Lerp'](b4,b5,0.5),b7=b4['subtract'](b5),b8=new N['Vector3'](...p['kneeL']['metric']),b9=new N['Vector3'](...p['ankleL']['metric']),bk=new N['Vector3'](...p['footIndexL']['metric']),bb=new N['Vector3'](...p['heelL']['metric']),bV=b9['subtract'](b8)['normalize'](),bs=bk['subtract'](bb)['normalize'](),bn=bV['cross'](bs)['normalize'](),bj=N['Vector3']['Lerp'](bb,bk,0.8),bO=N['Vector3']['Lerp'](k6,bn,0.2),bP=N['Vector3']['Lerp'](k6,bn,0.6),bh=new N['Vector3'](...p['kneeR']['metric']),bN=new N['Vector3'](...p['ankleR']['metric']),bG=new N['Vector3'](...p['footIndexR']['metric']),bU=new N['Vector3'](...p['heelR']['metric']),bW=bN['subtract'](bh)['normalize'](),br=bG['subtract'](bU)['normalize'](),bZ=bW['cross'](br)['normalize'](),bw=N['Vector3']['Lerp'](bU,bG,0.8),bE=N['Vector3']['Lerp'](k6,bZ,0.2),bx=N['Vector3']['Lerp'](k6,bZ,0.6);return{'hips':this['estimateBone'](k4,ki,k5),'spine':this['estimateBone'](ki,kX,kC),'spine1':this['estimateBone'](kX,kI,kc),'spine2':this['estimateBone'](kI,kj,ku),'neck':this['estimateBone'](kj,kv,ky),'head':this['estimateBone'](kv,km,kD),'headEnd':this['estimateBone'](km,kY,kD),'shoulderL':this['estimateBone'](kW,k7,kd),'armL':this['estimateBone'](k7,k9,kq),'foreArmL':this['estimateBone'](k9,kJ,kH),'handL':this['estimateBone'](kJ,kp,kQ),'shoulderR':this['estimateBone'](kr,k8,b2),'armR':this['estimateBone'](k8,kk,b3),'foreArmR':this['estimateBone'](kk,b0,b1),'handR':this['estimateBone'](b0,b6,b7),'upLegL':this['estimateBone'](k2,b8,bO),'legL':this['estimateBone'](b8,b9,bP),'footL':this['estimateBone'](b9,bj,bn),'toeL':this['estimateBone'](bj,bk,bn),'upLegR':this['estimateBone'](k3,bh,bE),'legR':this['estimateBone'](bh,bN,bx),'footR':this['estimateBone'](bN,bw,bZ),'toeR':this['estimateBone'](bw,bG,bZ)};}['estimateBone'](d,q,T){const p=q['subtract'](d)['normalize'](),Q=T['clone']()['normalize']()['cross'](p)['normalize'](),k0=p['cross'](Q);return{'position':d['clone'](),'rotation':N['Quaternion']['RotationQuaternionFromAxis'](k0,p,Q)};}['alignBone'](d,q,T=!0x0){let a=d['rotation']['clone'](),p=d['position']['clone']();q['parent']instanceof N['TransformNode']&&(p=N['Vector3']['TransformCoordinates'](p,q['parent']['computeWorldMatrix'](!0x0)['clone']()['invert']()),a=q['parent']['absoluteRotationQuaternion']['conjugate']()['multiply'](a),T&&(q['parent']['scaling']['setAll'](p['length']()/q['position']['length']()),p=N['Vector3']['TransformCoordinates'](d['position']['clone'](),q['parent']['computeWorldMatrix'](!0x0)['clone']()['invert']()))),q['position']=p,q['rotationQuaternion']=a;}}class y extends Y{constructor(d,q,T={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(d,T),this['outfit']=q;}['setNode'](d){super['setNode'](d);const {outfit:q,node:T}=this;!q||!T||T['getChildMeshes']()['forEach'](a=>{const p=Q=>Q==null?void 0x0:Q['some'](k0=>typeof k0=='string'?a['name']===k0:k0['test'](a['name']));if(p(q['occluders'])){a['material']&&(a['material']['disableColorWrite']=!0x0,a['material']['needDepthPrePass']=!0x0),a['renderingGroupId']=0x0;return;}if(p(q['hidden'])){a['setEnabled'](!0x1);return;}});}['setOutfit'](d,q){this['outfit']=q,this['setNode'](d);}}class F extends Y{constructor(d,q,T,a,p={'spineCurve':0.5,'neckAdjust':0.01,'headRatio':0.32,'shoulderDY':-0.01,'shoulderDZ':0.005}){super(d,p),this['translation']=q,this['rotation']=T,this['scale']=a;}async['update'](d,q){await super['update'](d,q);const T=d['poses']&&d['poses']['length']>0x0?d['poses'][0x0]['points']:void 0x0,{node:p,translation:Q,rotation:k0,scale:k1}=this;if(!p||!T)return;const k2=new N['Vector3'](...T['hipL']['metric']),k3=new N['Vector3'](...T['hipR']['metric']),k4=N['Vector3']['Lerp'](k2,k3,0.5);p['position']=Q?k4['add'](Q):k4,k0&&(p['rotationQuaternion']=k0),k1&&(p['scaling']=new N['Vector3']()['setAll'](k1));}['updateSpine'](d){const {skeletonNodes:q}=this;!q||(this['alignBone'](d['hips'],q['hips']),this['alignBone'](d['spine'],q['spine']),this['alignBone'](d['spine1'],q['spine1']),this['alignBone'](d['spine2'],q['spine2']),this['alignBone'](d['neck'],q['neck']),this['alignBone'](d['head'],q['head']),this['alignBone'](d['shoulderL'],q['shoulderL']),this['alignBone'](d['shoulderR'],q['shoulderR']));}['alignBone'](d,q){let T=d['rotation']['clone']();q['parent']instanceof N['TransformNode']&&(q['parent']['computeWorldMatrix'](!0x0),T=q['parent']['absoluteRotationQuaternion']['conjugate']()['multiply'](T)),q['rotationQuaternion']=T;}}const o=0.5,z=0x200,S=20.1,i='\x0a\x20\x20\x20\x20precision\x20mediump\x20float;\x0a\x20\x20\x20\x20varying\x20vec2\x20coords;\x0a\x20\x20\x20\x20uniform\x20vec2\x20size;\x0a\x20\x20\x20\x20uniform\x20vec4\x20box;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20image;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20mask;\x0a\x0a\x20\x20\x20\x20float\x20readMask(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(mask,\x20(coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size\x20-\x20box.xy)\x20/\x20box.zw).r;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20void\x20main()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20texture2D(mask,\x20(coords\x20-\x20box.xy)\x20/\x20(box.zw)).r\x20<\x20'+o+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20color\x20=\x20texture2D(image,\x20coords);\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bg)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+z+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x20x0\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20-x0,\x200.0)\x20<\x20'+o+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(-x0,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx0\x20=\x20bg\x20&&\x20x0\x20<\x20'+S+'\x20&&\x20readMask(coords,\x20-x0\x20*\x202.0\x20+\x201.0,\x200.0)\x20<\x20'+o+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(-x0\x20*\x202.0\x20+\x201.0,\x200)\x20/\x20size)\x20:\x20cx0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x201.0\x20/\x20x0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+z+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x20x1\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20x1,\x200.0)\x20<\x20'+o+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(x1,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx1\x20=\x20bg\x20&&\x20x1\x20<\x20'+S+'\x20&&\x20readMask(coords,\x20x1\x20*\x202.0\x20-\x201.0,\x200.0)\x20<\x20'+o+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(x1\x20*\x202.0\x20-\x201.0,\x200)\x20/\x20size)\x20:\x20cx1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x201.0\x20/\x20x1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+z+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x20y0\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20-y0)\x20<\x20'+o+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-y0)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy0\x20=\x20bg\x20&&\x20y0\x20<\x20'+S+'\x20&&\x20readMask(coords,\x200.0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20<\x20'+o+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20/\x20size)\x20:\x20cy0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x201.0\x20/\x20y0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+z+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x20y1\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20y1)\x20<\x20'+o+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20y1)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy1\x20=\x20bg\x20&&\x20y1\x20<\x20'+S+'\x20&&\x20readMask(coords,\x200.0,\x202.0\x20*\x20y1\x20+\x201.0)\x20<\x20'+o+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x202.0\x20*\x20y1\x20+\x201.0)\x20/\x20size)\x20:\x20cy1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x201.0\x20/\x20y1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20s\x20=\x201.0\x20/\x20(x0\x20+\x20x1\x20+\x20y0\x20+\x20y1);\x0a\x20\x20\x20\x20\x20\x20\x20\x20color\x20=\x20cx0\x20*\x20x0\x20*\x20s\x20+\x20cx1\x20*\x20x1\x20*\x20s\x20+\x20cy0\x20*\x20y0\x20*\x20s\x20+\x20cy1\x20*\x20y1\x20*\x20s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20}\x0a';class C extends n{constructor(){super(['image','mask'],{'size':'2f','flip':'1f','box':'4f'},i);}async['load'](d){const q=d instanceof P&&d['shaderCtx'];if(this['loaded']||!q)return;const T={'width':0x100,'height':0x100};return this['maskTexture']=new h(q,T,!0x0),this['dilationShader']=new e(q,T,0x2),super['load'](d);}['unload'](){var d,q;!this['loaded']||((d=this['dilationShader'])==null||d['dispose'](),delete this['dilationShader'],(q=this['maskTexture'])==null||q['dispose'](),delete this['maskTexture'],super['unload']());}['process'](q,T){var p,Q,k0,k1,k2,k3,k4,k5;const k6=q['poses']&&q['poses']['length']>0x0&&q['poses'][0x0]['mask'];if(!k6)return!0x1;(p=this['maskTexture'])==null||p['resize'](k6['size']),(Q=this['maskTexture'])==null||Q['update'](k6['buffer']),(k0=this['dilationShader'])==null||k0['resize'](k6['size']),(k2=this['dilationShader'])==null||k2['process']([((k1=this['maskTexture'])==null?void 0x0:k1['texture']())||null]);const k7=k6['box'];return(k5=this['shader'])==null||k5['process']([T,((k4=(k3=this['dilationShader'])==null?void 0x0:k3['output'])==null?void 0x0:k4['texture']())||null],{'box':[k7[0x0][0x0],k7[0x0][0x1],k7[0x1][0x0]-k7[0x0][0x0],k7[0x1][0x1]-k7[0x0][0x1]]}),!0x0;}}const A=0.5,K=0x200,X=0x40,c=20.1,M='\x0a\x20\x20\x20\x20precision\x20mediump\x20float;\x0a\x20\x20\x20\x20varying\x20vec2\x20coords;\x0a\x20\x20\x20\x20uniform\x20vec2\x20size;\x0a\x20\x20\x20\x20uniform\x20vec4\x20box;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20image;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20mask;\x0a\x20\x20\x20\x20uniform\x20sampler2D\x20part;\x0a\x0a\x20\x20\x20\x20float\x20readMask(vec2\x20coords,\x20float\x20dx,\x20float\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(mask,\x20(coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size\x20-\x20box.xy)\x20/\x20box.zw).r;\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20vec4\x20readPart(vec2\x20coords,\x20int\x20dx,\x20int\x20dy)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec2\x20offset\x20=\x20coords\x20+\x20vec2(dx,\x20dy)\x20/\x20size;\x0a\x20\x20\x20\x20\x20\x20\x20\x20return\x20texture2D(part,\x20vec2(offset.x,\x201.0\x20-\x20offset.y));\x0a\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20void\x20main()\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20bool\x20bg\x20=\x20texture2D(mask,\x20(coords\x20-\x20box.xy)\x20/\x20(box.zw)).r\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20color\x20=\x20texture2D(image,\x20coords);\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(bg)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20part\x20=\x20texture2D(part,\x20vec2(coords.x,\x201.0\x20-\x20coords.y));\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(part.g\x20>\x200.5\x20||\x20part.r\x20>\x200.5)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20dmin\x20=\x20float('+(0x2*X+0x1)+');\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+X+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x20xi,\x200);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20float(xi),\x200.0)\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(xi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(xi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+X+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x20-xi,\x200);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20float(-xi),\x200.0)\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(xi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(xi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+X+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x200,\x20yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20float(yi))\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(yi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(yi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+X+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20partD\x20=\x20readPart(coords,\x200,\x20-yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20float(-yi))\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bool\x20closer\x20=\x20!bg\x20&&\x20(partD.r\x20>\x200.5\x20||\x20partD.g\x20>\x200.5)\x20&&\x20float(yi)\x20<\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20part\x20=\x20closer\x20?\x20partD\x20:\x20part;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20dmin\x20=\x20closer\x20?\x20float(yi)\x20:\x20dmin;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20if\x20(part.g\x20>\x200.5\x20||\x20part.r\x20<=\x200.5)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20return;\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+K+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x20x0\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20-x0,\x200.0)\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(-x0,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx0\x20=\x20bg\x20&&\x20x0\x20<\x20'+c+'\x20&&\x20readMask(coords,\x20-x0\x20*\x202.0\x20+\x201.0,\x200.0)\x20<\x20'+A+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(-x0\x20*\x202.0\x20+\x201.0,\x200)\x20/\x20size)\x20:\x20cx0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x0\x20=\x20bg\x20?\x201.0\x20/\x20x0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20x1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20xi\x20=\x201;\x20xi\x20<\x20'+K+';\x20xi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x20x1\x20:\x20float(xi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x20x1,\x200.0)\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cx1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(x1,\x200)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cx1\x20=\x20bg\x20&&\x20x1\x20<\x20'+c+'\x20&&\x20readMask(coords,\x20x1\x20*\x202.0\x20-\x201.0,\x200.0)\x20<\x20'+A+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(x1\x20*\x202.0\x20-\x201.0,\x200)\x20/\x20size)\x20:\x20cx1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20x1\x20=\x20bg\x20?\x201.0\x20/\x20x1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y0\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+K+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x20y0\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20-y0)\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy0\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-y0)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy0\x20=\x20bg\x20&&\x20y0\x20<\x20'+c+'\x20&&\x20readMask(coords,\x200.0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20<\x20'+A+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20-2.0\x20*\x20y0\x20+\x201.0)\x20/\x20size)\x20:\x20cy0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y0\x20=\x20bg\x20?\x201.0\x20/\x20y0\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20false;\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20y1\x20=\x201.0;\x0a\x20\x20\x20\x20\x20\x20\x20\x20for\x20(int\x20yi\x20=\x201;\x20yi\x20<\x20'+K+';\x20yi++)\x20{\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x20y1\x20:\x20float(yi);\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20bg\x20=\x20bg\x20||\x20readMask(coords,\x200.0,\x20y1)\x20<\x20'+A+';\x0a\x20\x20\x20\x20\x20\x20\x20\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20vec4\x20cy1\x20=\x20bg\x20?\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x20y1)\x20/\x20size)\x20:\x20color;\x0a\x20\x20\x20\x20\x20\x20\x20\x20cy1\x20=\x20bg\x20&&\x20y1\x20<\x20'+c+'\x20&&\x20readMask(coords,\x200.0,\x202.0\x20*\x20y1\x20+\x201.0)\x20<\x20'+A+'\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20texture2D(image,\x20coords\x20+\x20vec2(0,\x202.0\x20*\x20y1\x20+\x201.0)\x20/\x20size)\x20:\x20cy1;\x0a\x20\x20\x20\x20\x20\x20\x20\x20y1\x20=\x20bg\x20?\x201.0\x20/\x20y1\x20:\x200.0;\x0a\x0a\x20\x20\x20\x20\x20\x20\x20\x20float\x20s\x20=\x201.0\x20/\x20(x0\x20+\x20x1\x20+\x20y0\x20+\x20y1);\x0a\x20\x20\x20\x20\x20\x20\x20\x20color\x20=\x20cx0\x20*\x20x0\x20*\x20s\x20+\x20cx1\x20*\x20x1\x20*\x20s\x20+\x20cy0\x20*\x20y0\x20*\x20s\x20+\x20cy1\x20*\x20y1\x20*\x20s;\x0a\x20\x20\x20\x20\x20\x20\x20\x20gl_FragColor\x20=\x20color;\x0a\x20\x20\x20\x20}\x0a';class I extends n{constructor(d=[],q=[]){super(['image','mask','part'],{'size':'2f','flip':'1f','box':'4f'},M),this['patchParts']=d,this['keepParts']=q,this['partsSkeletons']=[];}['setParts'](d=[],q=[]){this['partsSkeletons']=[],this['patchParts']=d,this['keepParts']=q,this['partsTarget']&&(this['partsTarget']['renderList']=[...d,...q],this['partsTarget']['setMaterialForRendering'](d,this['patchMaterial']),this['partsTarget']['setMaterialForRendering'](q,this['keepMaterial']),this['partsTarget']['renderList']['forEach'](T=>T['skeleton']&&this['partsSkeletons']['indexOf'](T['skeleton'])<0x0&&this['partsSkeletons']['push'](T['skeleton'])));}async['load'](d){if(!(d instanceof L))return;const {scene:q,shaderCtx:T}=d;if(this['loaded']||!T)return;const a={'width':0x100,'height':0x100};return this['maskTexture']=new h(T,a,!0x0),this['dilationShader']=new e(T,a,0x1),this['partsTarget']=new N['RenderTargetTexture']('MasksTarget',this['size'],q),this['partsTarget']['clearColor']=new N['Color4'](0x0,0x0,0x0,0x1),this['patchMaterial']=new N['StandardMaterial']('PatchMaskMaterial',q),this['patchMaterial']['emissiveColor']=new N['Color3'](0x1,0x0,0x0),this['patchMaterial']['disableLighting']=!0x0,this['keepMaterial']=new N['StandardMaterial']('KeepMaskMaterial',q),this['keepMaterial']['emissiveColor']=new N['Color3'](0x0,0x1,0x0),this['keepMaterial']['disableLighting']=!0x0,this['setParts'](this['patchParts'],this['keepParts']),super['load'](d);}['unload'](){var d,q,T,a,p;!this['loaded']||((d=this['dilationShader'])==null||d['dispose'](),delete this['dilationShader'],(q=this['maskTexture'])==null||q['dispose'](),delete this['maskTexture'],(T=this['partsTarget'])==null||T['dispose'](),delete this['partsTarget'],(a=this['patchMaterial'])==null||a['dispose'](),delete this['patchMaterial'],(p=this['keepMaterial'])==null||p['dispose'](),delete this['keepMaterial'],super['unload']());}['process'](q,T){var p,Q,k0,k1,k2;const k3=q['poses']&&q['poses']['length']>0x0&&q['poses'][0x0]['mask'],{partsTarget:k4,partsSkeletons:k5,maskTexture:k6,dilationShader:k7,shader:k8}=this;if(!k3||!k4||!k6||!k7||!k8)return!0x1;k5['forEach'](kb=>kb['prepare']()),(p=k4['renderList'])==null||p['forEach'](kb=>kb['computeWorldMatrix'](!0x0)),k4['render'](),k6['resize'](k3['size']),k6['update'](k3['buffer']),k7['resize'](k3['size']),k7['process']([((Q=this['maskTexture'])==null?void 0x0:Q['texture']())||null]);const k9=(k1=(k0=k4['getInternalTexture']())==null?void 0x0:k0['_hardwareTexture'])==null?void 0x0:k1['_webGLTexture'],kk=k3['box'];return k8==null||k8['process']([T,((k2=k7['output'])==null?void 0x0:k2['texture']())||null,k9||null],{'box':[kk[0x0][0x0],kk[0x0][0x1],kk[0x1][0x0]-kk[0x0][0x0],kk[0x1][0x1]-kk[0x0][0x1]]}),!0x0;}['setupVideo'](d){var q;super['setupVideo'](d),(q=this['partsTarget'])==null||q['resize'](d),this['setParts'](this['patchParts'],this['keepParts']);}}class u extends B{constructor(d,q=0x0){super(),this['node']=d,this['renderOrder']=q;}async['load'](d){if(!this['loaded'])return this['node']instanceof N['AbstractMesh']&&(this['node']['material']&&(this['node']['material']['disableColorWrite']=!0x0,this['node']['material']['needDepthPrePass']=!0x0),this['node']['renderingGroupId']=this['renderOrder']),this['node']['getChildMeshes'](!0x1)['forEach'](q=>{q['material']&&(q['material']['disableColorWrite']=!0x0,q['material']['needDepthPrePass']=!0x0),q['renderingGroupId']=this['renderOrder'];}),super['load'](d);}}class J extends N['StandardMaterial']{constructor(d,q){super(d,q),this['disableColorWrite']=!0x0,this['needDepthPrePass']=!0x0;}}export{B as BabylonPlugin,x as BabylonRenderer,L as BabylonUniRenderer,C as BodyPatchPlugin,I as BodypartPatchPlugin,m as FaceMaskPlugin,l as FacePlugin,f as FaceRenderer,t as FaceTrackPlugin,v as HeadTrackPlugin,J as OccluderMaterial,u as OccluderPlugin,Y as PoseAlignPlugin,y as PoseOutfitPlugin,D as PosePlugin,R as PoseRenderer,F as PoseTwinPlugin};
